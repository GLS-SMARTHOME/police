<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Live Map with Police Stations & SOS</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }
  #map {
    height: 100%;
    width: 100%;
  }
  #sos-btn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    padding: 12px 24px;
    font-size: 18px;
    background-color: #FF0000;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  #sos-btn:active {
    background-color: #cc0000;
  }
  button.info-btn {
    padding: 5px 10px;
    margin-top: 5px;
    background-color: #4285F4;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  button.info-btn:hover {
    background-color: #3367D6;
  }
</style>
</head>
<body>
<div id="map"></div>
<button id="sos-btn">SOS</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAIlkvwyaF6FPPbXBJDqHwuTS5S3QKG3l8",
  authDomain: "xoxo-store.firebaseapp.com",
  databaseURL: "https://xoxo-store-default-rtdb.firebaseio.com",
  projectId: "xoxo-store",
  storageBucket: "xoxo-store.firebasestorage.app",
  messagingSenderId: "667290233046",
  appId: "1:667290233046:web:dbbc9130ff38b0900f8177",
  measurementId: "G-XMJVCK8KMD"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let map, userMarker, pulseCircle, userPosition;
let pulseRadius = 0, growing = true, firstUpdate = true;
let userId = 'user_' + Date.now();
let directionsService, directionsRenderer;
let openInfoWindow = null;
let sosActive = false;

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 15,
    center: { lat: 0, lng: 0 },
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: false });
  directionsRenderer.setMap(map);

  loadPoliceStations();
  initUserLocation();

  // SOS button click
  document.getElementById('sos-btn').addEventListener('click', triggerSOS);
}

function initUserLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      (position) => {
        userPosition = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };

        if (firstUpdate) {
          map.setCenter(userPosition);
          firstUpdate = false;
        }

        if (!userMarker) {
          const scaleSize = window.innerWidth < 600 ? 6 : 8;
          userMarker = new google.maps.Marker({
            position: userPosition,
            map: map,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: scaleSize,
              fillColor: sosActive ? "#FF0000" : "#4285F4",
              fillOpacity: 1,
              strokeWeight: 0,
            }
          });

          pulseCircle = new google.maps.Circle({
            strokeColor: sosActive ? "#FF0000" : "#4285F4",
            strokeOpacity: 0.5,
            strokeWeight: 2,
            fillColor: sosActive ? "#FF0000" : "#4285F4",
            fillOpacity: 0.2,
            map: map,
            center: userPosition,
            radius: pulseRadius
          });

          requestAnimationFrame(animatePulse);
        } else {
          userMarker.setPosition(userPosition);
          pulseCircle.setCenter(userPosition);
        }

        // Save location and SOS
        database.ref('users/' + userId).set({
          lat: userPosition.lat,
          lng: userPosition.lng,
          sos: sosActive,
          timestamp: Date.now()
        });

        // Update open info window distance
        if (openInfoWindow && openInfoWindow.station) {
          updateInfoWindow(openInfoWindow, openInfoWindow.station);
        }
      },
      (error) => console.error("Error getting location:", error),
      { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
    );
  } else {
    alert("Geolocation not supported.");
  }
}

function animatePulse() {
  if (growing) pulseRadius += 1;
  else pulseRadius -= 1;

  let maxRadius = sosActive ? 100 : 50;
  if (pulseRadius > maxRadius) growing = false;
  if (pulseRadius < 5) growing = true;

  if (pulseCircle) pulseCircle.setRadius(pulseRadius);
  requestAnimationFrame(animatePulse);
}

function triggerSOS() {
  sosActive = true;
  if (userMarker) {
    userMarker.setIcon({
      path: google.maps.SymbolPath.CIRCLE,
      scale: window.innerWidth < 600 ? 6 : 8,
      fillColor: "#FF0000",
      fillOpacity: 1,
      strokeWeight: 0,
    });
  }
  if (pulseCircle) {
    pulseCircle.setOptions({
      strokeColor: "#FF0000",
      fillColor: "#FF0000"
    });
  }
  alert("SOS Activated!");
}

let policeInfoWindows = [];

function loadPoliceStations() {
  const stationsRef = database.ref('police_stations');
  stationsRef.on('value', (snapshot) => {
    const stations = snapshot.val();
    if (stations) {
      Object.keys(stations).forEach(key => {
        const station = stations[key];
        const marker = new google.maps.Marker({
          position: { lat: station.lat, lng: station.lng },
          map: map,
          title: station.name,
          icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/police.png',
            scaledSize: new google.maps.Size(40, 40)
          }
        });

        const infoWindow = new google.maps.InfoWindow();
        policeInfoWindows.push({ infoWindow, marker, station });

        marker.addListener('click', () => {
          if (openInfoWindow) openInfoWindow.close();
          openInfoWindow = infoWindow;
          openInfoWindow.station = station;
          updateInfoWindow(infoWindow, station, true);
          infoWindow.open(map, marker);
        });
      });
    }
  });
}

function updateInfoWindow(infoWindow, station, showButton = false) {
  let distanceText = '';
  if (userPosition) {
    const distance = getDistance(userPosition.lat, userPosition.lng, station.lat, station.lng);
    distanceText = `<p>Distance: ${distance.toFixed(2)} km</p>`;
  }
  let buttonHTML = '';
  if (showButton && userPosition) {
    buttonHTML = `<button class="info-btn" onclick="createRoute(${station.lat}, ${station.lng})">Create Route</button>`;
  }
  infoWindow.setContent(`
    <div>
      <h3>${station.name}</h3>
      <p>Phone: ${station.phone || 'N/A'}</p>
      ${distanceText}
      ${buttonHTML}
    </div>
  `);
}

function createRoute(lat, lng) {
  if (!userPosition) return alert("User location not available");
  if (!directionsService || !directionsRenderer) return;

  directionsService.route({
    origin: userPosition,
    destination: { lat: lat, lng: lng },
    travelMode: 'DRIVING'
  }, (result, status) => {
    if (status === 'OK') {
      directionsRenderer.setDirections(result);
    } else {
      alert("Could not create route: " + status);
    }
  });
}

function getDistance(lat1, lng1, lat2, lng2) {
  function toRad(x) { return x * Math.PI / 180; }
  const R = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjdnkFWOnh1u2cWf5RFURytU8Zk3fmOhk&callback=initMap">
</script>
</body>
</html>
