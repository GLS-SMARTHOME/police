<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Live Map with Police Stations & SOS</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }
  #map {
    height: 100%;
    width: 100%;
  }
  #sos-btn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    padding: 12px 24px;
    font-size: 18px;
    background-color: #FF0000;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  #sos-btn:active {
    background-color: #cc0000;
  }
</style>
</head>
<body>
<div id="map"></div>
<button id="sos-btn">SOS</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAIlkvwyaF6FPPbXBJDqHwuTS5S3QKG3l8",
  authDomain: "xoxo-store.firebaseapp.com",
  databaseURL: "https://xoxo-store-default-rtdb.firebaseio.com",
  projectId: "xoxo-store",
  storageBucket: "xoxo-store.firebasestorage.app",
  messagingSenderId: "667290233046",
  appId: "1:667290233046:web:dbbc9130ff38b0900f8177",
  measurementId: "G-XMJVCK8KMD"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let map, directionsService, directionsRenderer;
let userId = "user_" + Date.now();
let userPosition = null;
let firstUpdate = true;
let sosActive = false;

let userMarker, pulseCircle, pulseRadius = 0, growing = true;

// Store all other users
let otherUsers = {}; 

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 15,
    center: { lat: 0, lng: 0 },
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();
  directionsRenderer.setMap(map);

  initUserLocation();
  listenOtherUsers();

  document.getElementById("sos-btn").addEventListener("click", triggerSOS);
}

function initUserLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      (position) => {
        userPosition = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };

        if (firstUpdate) {
          map.setCenter(userPosition);
          firstUpdate = false;
        }

        updateUserMarker();
        saveUserLocation();
      },
      (err) => console.error("Geolocation error:", err),
      { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
    );
  } else {
    alert("Geolocation not supported");
  }
}

function updateUserMarker() {
  const color = sosActive ? "#FF0000" : "#4285F4";
  const scaleSize = window.innerWidth < 600 ? 10 : 14;

  if (!userMarker) {
    userMarker = new google.maps.Marker({
      position: userPosition,
      map: map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: scaleSize,
        fillColor: color,
        fillOpacity: 1,
        strokeWeight: 0,
      },
    });

    pulseCircle = new google.maps.Circle({
      strokeColor: color,
      strokeOpacity: 0.5,
      strokeWeight: 2,
      fillColor: color,
      fillOpacity: 0.2,
      map: map,
      center: userPosition,
      radius: 0,
    });

    requestAnimationFrame(animatePulse);
  } else {
    userMarker.setPosition(userPosition);
    userMarker.setIcon({
      path: google.maps.SymbolPath.CIRCLE,
      scale: scaleSize,
      fillColor: color,
      fillOpacity: 1,
      strokeWeight: 0,
    });
    pulseCircle.setOptions({ strokeColor: color, fillColor: color });
    pulseCircle.setCenter(userPosition);
  }
}

function animatePulse() {
  if (!pulseCircle) return;
  if (growing) pulseRadius += 5;
  else pulseRadius -= 5;

  let maxRadius = sosActive ? screenPercentToMeters(20) : screenPercentToMeters(10);
  if (pulseRadius > maxRadius) growing = false;
  if (pulseRadius < 20) growing = true;

  pulseCircle.setRadius(pulseRadius);
  requestAnimationFrame(animatePulse);
}

// Convert % of screen width to meters
function screenPercentToMeters(percent) {
  if (!map || !userPosition) return 100;
  const bounds = map.getBounds();
  if (!bounds) return 100;

  const center = map.getCenter();
  const ne = bounds.getNorthEast();
  const sw = bounds.getSouthWest();

  const east = { lat: center.lat(), lng: ne.lng() };
  const west = { lat: center.lat(), lng: sw.lng() };
  const mapWidthMeters = getDistance(east.lat, east.lng, west.lat, west.lng) * 1000;

  return (mapWidthMeters * percent) / 100;
}

// Save my location to Firebase
function saveUserLocation() {
  if (!userPosition) return;
  database.ref("users/" + userId).set({
    lat: userPosition.lat,
    lng: userPosition.lng,
    sos: sosActive,
    timestamp: Date.now(),
  });
}

function triggerSOS() {
  sosActive = !sosActive;
  updateUserMarker();
  saveUserLocation();
  alert(sosActive ? "ðŸš¨ SOS Activated!" : "âœ… SOS Deactivated");
}

// Listen for other users in Firebase
function listenOtherUsers() {
  const usersRef = database.ref("users");
  usersRef.on("value", (snapshot) => {
    const users = snapshot.val();
    if (!users) return;

    Object.keys(users).forEach((id) => {
      if (id === userId) return; // skip myself
      const data = users[id];

      if (!otherUsers[id]) {
        const marker = new google.maps.Marker({
          position: { lat: data.lat, lng: data.lng },
          map: map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: data.sos ? "#FF0000" : "#4285F4",
            fillOpacity: 1,
            strokeWeight: 0,
          },
        });
        otherUsers[id] = marker;
      } else {
        otherUsers[id].setPosition({ lat: data.lat, lng: data.lng });
        otherUsers[id].setIcon({
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: data.sos ? "#FF0000" : "#4285F4",
          fillOpacity: 1,
          strokeWeight: 0,
        });
      }
    });
  });
}

// Utility distance in km
function getDistance(lat1, lng1, lat2, lng2) {
  function toRad(x) { return x * Math.PI / 180; }
  const R = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjdnkFWOnh1u2cWf5RFURytU8Zk3fmOhk&callback=initMap">
</script>
</body>
</html>
